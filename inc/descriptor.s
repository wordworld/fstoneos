

; 表1. 描述符结构 ( 8 字节 )
; ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
; │0        │1        │2        │3        │4        │5        │6        │7        │
; ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
; │0   |4   │8   |12  │16  |20  │24  |28  │32  |36  │40  |44  │48  |52  │56  |60  │
; ├─────────┴─────────┼─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤
; │        lmt1       │      base1-L2     │ base1-H1│   att1  │lmt2|att2│  base2  │
; └───────────────────┴───────────────────┴─────────┴─────────┴─────────┴─────────┘
;                                                   /                   \
;  ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                     ─ ─ ─ ─ ─ 
; /                                                                               \
; ┌───────────────────┬────┬─────────┬────┬───────────────────┬────┬────┬────┬────┐
; │40   41   42   43  │44  │45   46  │47  │48   49   50   51  │52  │53  │54  │55  │
; ├───────────────────┼────┼─────────┼────┼───────────────────┼────┼────┼────┼────┤
; │        type       │  S │   DPL   │  P │       lmt2        │ AVL│    │ D/B│  G │
; └───────────────────┴────┴─────────┴────┴───────────────────┴────┴────┴────┴────┘
; │                   │    │特权级0~3│段在│                   │保留│    │    │0/1 │
; │                   └┐   └─────────┴────┤                   └────┘    │    │B/4k│
; │                    │   0    /   1     │    ┌────────────────────────┘    └────┤
; │                    │ 系统段 / 代码段  │    │ [可执行] [代码段]                │
; │                    │   门   / 数据段  │    │      D addr operand              │
; │                    └──────────────────┤    │      1 32b  32/8b                │
; │                                       │    │      0 16b  16/8b                │
; ├─────────┬─────────┬─────────┬─────────┤    │ [向下扩展] [数据段]              │
; │   40    │    41   │   42    │   43    │    │  段上界  = (B==1) ? 4G : 64k     │
; ├─────────┼─────────┼─────────┼─────────┤    │ [描述堆栈段] push pop call 时,   │
; │  已访问 │   可写  │ 向下扩展│执行/一致│    │  堆栈指针寄存器= (B==1)?ESP:SP   │
; └─────────┴─────────┴─────────┴─────────┘    └──────────────────────────────────┘

; 描述符
; usage: Descriptor Base, Limit, Attr
; @param 1	段基址	dd	4B	(segment base address)
; @param 2	段界限	dd	2.5B	(segment limit)
; @param 3	段属性	dw	1.5B	(segment attribute)
%macro Descriptor 3
	dw	%2 & 0FFFFh				; lmt1		( 0-15,16)
	dw	%1 & 0FFFFh				; base1-Low 2B	(16-31,16)
	db	(  %1 >> 16 ) &  0FFh			; base1-High1B	(32-39, 8)
	dw	( (%2 >>  8 ) & 0F00h ) | (%3 & 0F0FFh)	; att1 (40-47,8); lmt2 (48-51,4); att2 (52-55,4)
	db	(  %1 >> 24 ) &  0FFh			; base2		(56-63, 8)
%endmacro 


; 门
; usage: Gate Selector, Offset, DCount, Attr
;        Selector:  dw
;        Offset:    dd
;        DCount:    db
;        Attr:      db
%macro Gate 4
	dw	   %2 & 0FFFFh				; 偏移1
	dw	   %1					; 选择子
	dw	  (%3 & 1Fh) | ( (%4 << 8) & 0FF00h )	; 属性
	dw	( (%2 >> 16) & 0FFFFh )			; 偏移2
%endmacro ; 共 8 字节

; 描述符类型
DA_32		EQU	4000h	; 32 位段

; 存储段描述符类型
DA_DRW		EQU	92h	; 存在的可读写数据段属性值
DA_C		EQU	98h	; 存在的只执行代码段属性值


